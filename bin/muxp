#!/usr/bin/ruby
require 'yaml'
require 'shellwords'

if File.exist?(".env.muxp")
  env = YAML.load_file(".env.muxp")
  env.each do |k, v|
    ENV[k] = v.to_s
  end
end

ignored_tasks = %w(web)
ignored_tasks = [] if ENV['WEB']

project = File.basename(Dir.getwd)
tasks = YAML.load_file("Procfile")
ignored_tasks.each do |task_name|
  tasks.delete(task_name)
end

def session_running?(project)
  system("tmux has-session -t #{project.inspect} 2>/dev/null")
  $?.success?
end

def tmux_bin
  `which tmux`.strip
end

def tmux(cmd, raise_on_error: true, mode: :system)
  case mode
  when :system
    system("tmux #{cmd}")
    unless $?.success?
      raise("failed") if raise_on_error
      return false
    end
    true
  when :exec
    exec tmux_bin, *Shellwords.shellwords(cmd)
  end
end

if session_running?(project)
  puts "Killing existing session ..."
  tmux(%{kill-session -t "#{project}"})
end

puts "Starting new session ..."
tmux %{new-session -s "#{project}" -n "#{project} Main" -d}
tmux %{send-keys "setpane shell" Enter}

# tmux %{set-window-option remain-on-exit on}
tmux %{set mouse on}

if tasks.length > 0
  keys = tasks.keys
  first_key = keys.pop
  tmux %{split-window -v -p 30 -t "#{project}:1"}
  tmux %{send-keys "setpane #{first_key}" Enter}
  tmux %{send-keys #{tasks[first_key].inspect} Enter}
  keys.each do |key|
    tmux %{split-window -h -t "#{project}:1"}
    tmux %{send-keys "setpane #{key}" Enter}
    tmux %{send-keys #{tasks[key].inspect} Enter}
  end
end

tmux %{new-window -t "#{project}:2" -n "Log"}
tmux %{send-keys "setpane Log" Enter}
tmux %{send-keys "tail -n 0 -f log/development.log" Enter}


tmux %{select-window -t "#{project}:1"}

puts "\e]0;tmux: #{project}\007"

tmux %{attach -t "#{project}"}#, mode: :exec
