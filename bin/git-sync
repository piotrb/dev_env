#!/usr/bin/env ruby

def sh(cmd)
  puts "+ #{cmd}"
  unless system(cmd)
    $stderr.puts "command failed with status: #{$?.exitstatus}"
    exit 1
  end
end

def get(cmd)
  result = `#{cmd}`
  unless $?.success?
    $stderr.puts "command failed with status: #{$?.exitstatus}"
    $stderr.puts "output: #{result}" unless result.strip.length == 0
    exit 1
  end
  result
end

current_branch = get('git symbolic-ref --short HEAD').strip

puts "Syncing current branch #{current_branch} to master ..."
puts "="*80

begin
  sh 'git checkout master -q'
  sh 'git pull'
ensure
  sh "git checkout #{current_branch.inspect} -q"
end

sh 'git rebase master'
